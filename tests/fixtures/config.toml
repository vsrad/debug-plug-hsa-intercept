[agent]
log = "-"

[[buffer-allocation]]
size = 1048576
dump-path = "tests/tmp/debug_buffer"
addr-env-name = "ASM_DBG_BUF_ADDR"
size-env-name = "ASM_DBG_BUF_SIZE"

[[buffer-allocation]]
size = 4096
addr-env-name = "ASM_HID_BUF_ADDR"

[code-object-dump]
log = "tests/tmp/co_dump.log"
directory = "tests/tmp/"

[[code-object-swap]]
when-call-count = 1
load-file = "tests/tmp/replacement.co"
exec-before-load = """bash -o pipefail -c '\
  perl tests/fixtures/breakpoint.pl -ba $ASM_DBG_BUF_ADDR -bs $ASM_DBG_BUF_SIZE \
      -w v[tid_dump] -l 37 -t 0 tests/kernels/dbg_kernel.s \
  | /opt/rocm/bin/hcc -x assembler -target amdgcn--amdhsa -mcpu=`/opt/rocm/bin/rocminfo | grep -om1 gfx9..` -mno-code-object-v3 \
    -Itests/kernels/include -o tests/tmp/replacement.co -'"""

[[code-object-swap]]
when-call-count = 2
load-file = "tests/tmp/replacement.co"
load-trap-handler-file = "tests/tmp/replacement.co"
exec-before-load = """bash -o pipefail -c '\
  perl tests/fixtures/breakpoint_trap.pl -ba $ASM_DBG_BUF_ADDR -bs $ASM_DBG_BUF_SIZE -hs 4096 \
      -w v[tid_dump] -e "s_nop 10" -l 37 -t 2 tests/kernels/dbg_kernel.s \
  | /opt/rocm/bin/hcc -x assembler -target amdgcn--amdhsa -mcpu=`/opt/rocm/bin/rocminfo | grep -om1 gfx9..` -mno-code-object-v3 \
    -Itests/kernels/include -o tests/tmp/replacement.co -'"""

[[code-object-swap]]
when-crc = 0xCAFE666
load-file = "replacement.co"
  [[code-object-swap.symbol]]
  name = "conv2d"
  replacement-name = "conv2d_test_new"
  [[code-object-swap.symbol]]
  name = "conv2d_transpose"
  replacement-name = "conv2d_test_new_transpose"

[[code-object-swap]]
when-crc = 0xDEADBEEF
load-file = "replacement.co"
